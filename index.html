<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<meta name="theme-color" content="#09090b">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>FlightDeck</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--bg:#09090b;--card:#18181b;--card2:#27272a;--border:#3f3f46;--accent:#3b82f6;--text:#fafafa;--text2:#a1a1aa;--green:#22c55e;--red:#ef4444;--yellow:#eab308;--radius:12px}
html,body{height:100%;font-family:-apple-system,BlinkMacSystemFont,'SF Pro Display','Segoe UI',Roboto,sans-serif;background:var(--bg);color:var(--text);overflow-x:hidden;-webkit-tap-highlight-color:transparent}
body{padding:env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left)}
::-webkit-scrollbar{width:3px}::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}

.header{position:sticky;top:0;z-index:100;background:var(--bg);padding:20px 16px 16px;border-bottom:1px solid var(--border)}
.header h1{font-size:20px;font-weight:700;letter-spacing:-.3px;display:flex;align-items:center;justify-content:space-between}
.header h1 .refresh-btn{width:32px;height:32px;border:1px solid var(--border);border-radius:8px;background:transparent;color:var(--text2);font-size:14px;cursor:pointer;display:flex;align-items:center;justify-content:center}
.header h1 .refresh-btn:active{background:var(--card)}
.header p{color:var(--text2);font-size:12px;margin-top:4px;font-weight:400}

.search-wrap{padding:12px 16px;position:relative}
.search-wrap input{width:100%;padding:12px 44px 12px 16px;border:1px solid var(--border);border-radius:10px;background:var(--card);color:var(--text);font-size:15px;outline:none;transition:.2s}
.search-wrap input:focus{border-color:var(--accent)}
.search-wrap input::placeholder{color:var(--text2)}
.search-btn{position:absolute;right:22px;top:50%;transform:translateY(-50%);width:32px;height:32px;border:none;border-radius:8px;background:var(--accent);color:#fff;font-size:13px;cursor:pointer;display:flex;align-items:center;justify-content:center}
.search-btn:active{opacity:.8}
.search-btn svg{width:16px;height:16px}

.recent-searches{padding:0 16px 8px;display:flex;gap:6px;flex-wrap:wrap}
.recent-chip{padding:5px 12px;border-radius:6px;background:var(--card);color:var(--text2);font-size:12px;font-weight:500;cursor:pointer;border:1px solid var(--border);transition:.2s}
.recent-chip:active{border-color:var(--accent)}

.tabs{display:flex;margin:4px 16px 12px;gap:0;border:1px solid var(--border);border-radius:8px;overflow:hidden}
.tab{flex:1;padding:8px;border:none;background:transparent;color:var(--text2);font-size:13px;font-weight:600;cursor:pointer;transition:.2s}
.tab.active{background:var(--accent);color:#fff}

.cards{padding:0 16px 100px;display:flex;flex-direction:column;gap:10px}

.loading{text-align:center;padding:40px 20px;color:var(--text2)}
.loading .spinner{width:28px;height:28px;border:2px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin .8s linear infinite;margin:0 auto 12px}
@keyframes spin{to{transform:rotate(360deg)}}

.flight-card{background:var(--card);border-radius:var(--radius);border:1px solid var(--border);overflow:hidden;animation:fadeIn .3s ease}
@keyframes fadeIn{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}

.card-top{padding:16px 16px 0;display:flex;justify-content:space-between;align-items:flex-start}
.card-top-left .flight-num{font-size:18px;font-weight:700;letter-spacing:.5px}
.card-top-left .airline-name{font-size:12px;color:var(--text2);margin-top:1px}
.card-top-right{display:flex;gap:6px;align-items:center}
.status-pill{padding:4px 10px;border-radius:6px;font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.3px}
.status-green{background:rgba(34,197,94,.12);color:var(--green)}
.status-yellow{background:rgba(234,179,8,.12);color:var(--yellow)}
.status-red{background:rgba(239,68,68,.12);color:var(--red)}
.status-blue{background:rgba(59,130,246,.12);color:var(--accent)}
.card-btn{width:28px;height:28px;border:1px solid var(--border);border-radius:6px;background:transparent;color:var(--text2);font-size:12px;cursor:pointer;display:flex;align-items:center;justify-content:center}
.card-btn:active{background:var(--card2)}
.card-btn.saved{color:var(--yellow);border-color:var(--yellow)}

.route-section{padding:16px;display:flex;align-items:center}
.airport-block{flex:1}
.airport-block.right{text-align:right}
.airport-block .code{font-size:28px;font-weight:800;letter-spacing:1px;line-height:1}
.airport-block .city{font-size:11px;color:var(--text2);margin-top:3px}
.airport-block .time-row{margin-top:8px}
.airport-block .time-sched{font-size:14px;font-weight:600}
.airport-block .time-tz{font-size:11px;color:var(--text2);margin-left:2px}
.airport-block .time-actual{font-size:13px;color:var(--green);font-weight:600}
.airport-block .time-delayed{font-size:12px;color:var(--text2);text-decoration:line-through}
.airport-block .time-label{font-size:10px;color:var(--text2);text-transform:uppercase;letter-spacing:.5px;margin-bottom:2px}

.route-middle{flex:0 0 80px;display:flex;flex-direction:column;align-items:center;gap:4px;position:relative}
.route-line-h{width:100%;height:1px;background:var(--border);position:relative}
.route-dot{width:6px;height:6px;border-radius:50%;background:var(--accent);position:absolute;top:-2.5px}
.route-dot.left{left:0}.route-dot.right{right:0}
.route-dur{font-size:10px;color:var(--text2);white-space:nowrap}

.progress-bar{height:3px;background:var(--card2);margin:0 16px}
.progress-fill{height:100%;background:var(--accent);transition:width 1s ease}

.detail-strip{display:flex;gap:0;border-top:1px solid var(--border);margin-top:0}
.detail-cell{flex:1;padding:10px 12px;text-align:center;border-right:1px solid var(--border)}
.detail-cell:last-child{border-right:none}
.detail-cell .dl{font-size:9px;color:var(--text2);text-transform:uppercase;letter-spacing:.5px}
.detail-cell .dv{font-size:13px;font-weight:600;margin-top:2px}

.codeshares-strip{padding:8px 16px;border-top:1px solid var(--border);font-size:11px;color:var(--text2)}
.codeshares-strip span{color:var(--text);font-weight:500}

.countdown-strip{padding:8px 16px;border-top:1px solid var(--border);font-size:12px;color:var(--accent);font-weight:600;text-align:center}

.empty{text-align:center;padding:60px 20px;color:var(--text2)}
.empty p{font-size:14px;line-height:1.7}
.empty .hint{font-size:12px;margin-top:8px;color:var(--border)}

.toast{position:fixed;bottom:30px;left:50%;transform:translateX(-50%) translateY(60px);background:var(--card2);color:var(--text);padding:10px 20px;border-radius:8px;font-size:13px;font-weight:500;z-index:300;transition:.3s;opacity:0;border:1px solid var(--border)}
.toast.show{transform:translateX(-50%) translateY(0);opacity:1}
</style>
</head>
<body>

<div class="header">
  <h1>FlightDeck <button class="refresh-btn" onclick="refreshAll()" title="Refresh all">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M1 4v6h6"/><path d="M23 20v-6h-6"/><path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"/></svg>
  </button></h1>
  <p id="subtitle">Live flight tracking</p>
</div>

<div class="search-wrap">
  <input type="text" id="searchInput" placeholder="Enter flight number (e.g. AC226)" autocomplete="off" autocapitalize="characters" spellcheck="false">
  <button class="search-btn" id="searchBtn" aria-label="Search">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
  </button>
</div>

<div class="recent-searches" id="recentSearches"></div>

<div class="tabs">
  <button class="tab active" data-filter="live">Live</button>
  <button class="tab" data-filter="saved">Saved</button>
</div>

<div class="cards" id="cards"></div>

<div class="toast" id="toast"></div>

<script>
const PROXY = 'https://api.allorigins.win/get?url=';
const FS_BASE = 'https://www.flightstats.com/v2/flight-tracker/';
const LS_FLIGHTS = 'fd_flights';
const LS_RECENT = 'fd_recent';
const LS_SAVED = 'fd_saved';

let liveFlights = JSON.parse(localStorage.getItem(LS_FLIGHTS) || '[]');
let savedFlights = JSON.parse(localStorage.getItem(LS_SAVED) || '[]');
let recentSearches = JSON.parse(localStorage.getItem(LS_RECENT) || '[]');
let currentFilter = 'live';
let isLoading = false;

const $ = id => document.getElementById(id);

function toast(msg) {
  const t = $('toast'); t.textContent = msg; t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2000);
}

function saveLive() { localStorage.setItem(LS_FLIGHTS, JSON.stringify(liveFlights)); }
function saveSaved() { localStorage.setItem(LS_SAVED, JSON.stringify(savedFlights)); }
function saveRecent() { localStorage.setItem(LS_RECENT, JSON.stringify(recentSearches)); }

function addRecent(q) {
  recentSearches = [q, ...recentSearches.filter(r => r !== q)].slice(0, 6);
  saveRecent();
  renderRecent();
}

function renderRecent() {
  $('recentSearches').innerHTML = recentSearches.map(r =>
    `<div class="recent-chip" onclick="searchFlight('${r}')">${r}</div>`
  ).join('');
}

function parseFlightCode(input) {
  const clean = input.trim().toUpperCase().replace(/\s+/g, '');
  const m = clean.match(/^([A-Z]{2}|\d[A-Z]|[A-Z]\d)(\d{1,4})$/);
  if (m) return { carrier: m[1], number: m[2] };
  return null;
}

async function fetchFlightData(carrier, number) {
  const url = `${FS_BASE}${carrier}/${number}`;
  const resp = await fetch(`${PROXY}${encodeURIComponent(url)}`);
  if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
  const data = await resp.json();
  if (!data.contents) throw new Error('Empty response');
  const match = data.contents.match(/__NEXT_DATA__\s*=\s*({.*?});/s);
  if (!match) throw new Error('Could not parse flight data');
  const nextData = JSON.parse(match[1]);
  const ft = nextData.props?.initialState?.flightTracker;
  if (!ft?.flight) throw new Error('No flight data found');
  return ft;
}

function getFlightId(ft) {
  return `${ft.flight.resultHeader.carrier.fs}${ft.flight.resultHeader.flightNumber}`;
}

function buildFlightCard(ft) {
  const f = ft.flight;
  const dep = f.departureAirport;
  const arr = f.arrivalAirport;
  const sched = f.schedule;
  const stat = f.status;
  const info = f.additionalFlightInfo;
  const header = f.resultHeader;
  const flightId = getFlightId(ft);

  const statusColor = stat.color === 'green' ? 'status-green' :
                      stat.color === 'yellow' ? 'status-yellow' :
                      stat.color === 'red' ? 'status-red' : 'status-blue';

  const isFlying = f.flightNote?.tracking || f.flightState === 'active';
  const isLanded = f.flightNote?.landed || f.flightState === 'completed';
  const isFuture = f.flightState === 'future';

  let progress = 0;
  if (isLanded) progress = 100;
  else if (isFlying && sched.scheduledDepartureUTC && sched.scheduledArrivalUTC) {
    const depT = new Date(sched.scheduledDepartureUTC).getTime();
    const arrT = new Date(sched.scheduledArrivalUTC).getTime();
    progress = Math.min(95, Math.max(5, ((Date.now() - depT) / (arrT - depT)) * 100));
  }

  let countdown = '';
  if (isFuture && sched.scheduledDepartureUTC) {
    const diff = new Date(sched.scheduledDepartureUTC) - new Date();
    if (diff > 0) {
      const h = Math.floor(diff / 36e5), m = Math.floor((diff % 36e5) / 6e4);
      if (h > 48) { const d = Math.floor(h / 24); countdown = `Departs in ${d}d ${h % 24}h`; }
      else countdown = h > 0 ? `Departs in ${h}h ${m}m` : `Departs in ${m}m`;
    }
  }

  const depSched = dep.times?.scheduled ? dep.times.scheduled.time24 : '--:--';
  const depTz = dep.times?.scheduled?.timezone || '';
  const arrSched = arr.times?.scheduled ? arr.times.scheduled.time24 : '--:--';
  const arrTz = arr.times?.scheduled?.timezone || '';
  const depActual = dep.times?.estimatedActual?.time24 || null;
  const arrActual = arr.times?.estimatedActual?.time24 || null;

  const depTimeHtml = depActual && depActual !== depSched
    ? `<div class="time-delayed">${depSched}</div><div class="time-actual">${depActual} <span class="time-tz">${depTz}</span></div>`
    : `<div class="time-sched">${depSched} <span class="time-tz">${depTz}</span></div>`;
  const arrTimeHtml = arrActual && arrActual !== arrSched
    ? `<div class="time-delayed">${arrSched}</div><div class="time-actual">${arrActual} <span class="time-tz">${arrTz}</span></div>`
    : `<div class="time-sched">${arrSched} <span class="time-tz">${arrTz}</span></div>`;

  const isSaved = savedFlights.some(s => getFlightId(s) === flightId);

  // Detail cells
  let details = [];
  if (dep.gate) details.push({ l: 'Gate', v: dep.gate });
  if (dep.terminal) details.push({ l: 'Term', v: dep.terminal });
  if (arr.gate) details.push({ l: 'Arr Gate', v: arr.gate });
  if (arr.terminal) details.push({ l: 'Arr Term', v: arr.terminal });
  if (arr.baggage) details.push({ l: 'Baggage', v: arr.baggage });
  if (info?.equipment?.name) details.push({ l: 'Aircraft', v: info.equipment.name });
  if (info?.flightDuration) details.push({ l: 'Duration', v: info.flightDuration });
  if (stat.delay?.departure?.minutes > 0) details.push({ l: 'Delay', v: `${stat.delay.departure.minutes}m` });

  let codeshareHtml = '';
  if (f.codeshares?.length) {
    codeshareHtml = `<div class="codeshares-strip">Also: <span>${f.codeshares.map(c => `${c.fs} ${c.flightNumber}`).join(', ')}</span></div>`;
  }

  return `
  <div class="flight-card">
    <div class="card-top">
      <div class="card-top-left">
        <div class="flight-num">${header.carrier.fs} ${header.flightNumber}</div>
        <div class="airline-name">${header.carrier.name}</div>
      </div>
      <div class="card-top-right">
        <div class="status-pill ${statusColor}">${stat.status}${stat.statusDescription && stat.statusDescription !== stat.status ? ' \u00b7 ' + stat.statusDescription : ''}</div>
        <button class="card-btn ${isSaved ? 'saved' : ''}" onclick="toggleSave('${flightId}')" title="Save">${isSaved ? '\u2605' : '\u2606'}</button>
        <button class="card-btn" onclick="removeLive('${flightId}')" title="Remove">\u00d7</button>
      </div>
    </div>
    <div class="route-section">
      <div class="airport-block">
        <div class="code">${dep.fs}</div>
        <div class="city">${dep.city}${dep.state ? ', ' + dep.state : ''}</div>
        <div class="time-row">
          <div class="time-label">Departure</div>
          ${depTimeHtml}
        </div>
      </div>
      <div class="route-middle">
        <div class="route-dur">${info?.flightDuration || ''}</div>
        <div class="route-line-h"><div class="route-dot left"></div><div class="route-dot right"></div></div>
      </div>
      <div class="airport-block right">
        <div class="code">${arr.fs}</div>
        <div class="city">${arr.city}${arr.state ? ', ' + arr.state : ''}</div>
        <div class="time-row">
          <div class="time-label">Arrival</div>
          ${arrTimeHtml}
        </div>
      </div>
    </div>
    ${(isFlying || isLanded) ? `<div class="progress-bar"><div class="progress-fill" style="width:${progress}%"></div></div>` : ''}
    ${details.length ? `<div class="detail-strip">${details.map(d => `<div class="detail-cell"><div class="dl">${d.l}</div><div class="dv">${d.v}</div></div>`).join('')}</div>` : ''}
    ${codeshareHtml}
    ${countdown ? `<div class="countdown-strip">${countdown}</div>` : ''}
  </div>`;
}

function render() {
  const c = $('cards');
  if (isLoading) {
    c.innerHTML = `<div class="loading"><div class="spinner"></div>Fetching flight data...</div>`;
    return;
  }
  const list = currentFilter === 'live' ? liveFlights : savedFlights;
  if (!list.length) {
    c.innerHTML = `<div class="empty"><p>${currentFilter === 'live' ? 'Search for a flight to get started.' : 'No saved flights.'}</p><div class="hint">${currentFilter === 'live' ? 'Try AC226, WS137, UA100' : 'Star a flight to save it'}</div></div>`;
  } else {
    c.innerHTML = list.map(f => buildFlightCard(f)).join('');
  }
  const total = liveFlights.length + savedFlights.length;
  $('subtitle').textContent = total ? `Tracking ${total} flight${total !== 1 ? 's' : ''}` : 'Live flight tracking';
}

async function searchFlight(query) {
  const q = query || $('searchInput').value;
  const parsed = parseFlightCode(q);
  if (!parsed) { toast('Invalid flight number'); return; }
  $('searchInput').value = `${parsed.carrier}${parsed.number}`;
  addRecent(`${parsed.carrier}${parsed.number}`);
  isLoading = true; render();
  try {
    const ft = await fetchFlightData(parsed.carrier, parsed.number);
    const fid = getFlightId(ft);
    liveFlights = liveFlights.filter(f => getFlightId(f) !== fid);
    liveFlights.unshift(ft);
    saveLive();
    currentFilter = 'live';
    document.querySelectorAll('.tab').forEach(t => t.classList.toggle('active', t.dataset.filter === 'live'));
    toast('Flight loaded');
  } catch (err) {
    toast('Not found: ' + err.message);
  }
  isLoading = false; render();
}

function removeLive(id) {
  liveFlights = liveFlights.filter(f => getFlightId(f) !== id);
  saveLive(); render();
}

function toggleSave(id) {
  const idx = savedFlights.findIndex(f => getFlightId(f) === id);
  if (idx >= 0) { savedFlights.splice(idx, 1); saveSaved(); render(); toast('Unsaved'); return; }
  const flight = liveFlights.find(f => getFlightId(f) === id);
  if (flight) { savedFlights.unshift(flight); saveSaved(); render(); toast('Saved'); }
}

async function refreshAll() {
  toast('Refreshing...');
  for (let i = 0; i < liveFlights.length; i++) {
    const carrier = liveFlights[i].flight.resultHeader.carrier.fs;
    const number = liveFlights[i].flight.resultHeader.flightNumber;
    try { liveFlights[i] = await fetchFlightData(carrier, number); } catch (e) {}
  }
  saveLive(); render(); toast('Updated');
}

$('searchBtn').addEventListener('click', () => searchFlight());
$('searchInput').addEventListener('keydown', e => { if (e.key === 'Enter') searchFlight(); });
document.querySelectorAll('.tab').forEach(t => {
  t.addEventListener('click', () => {
    document.querySelectorAll('.tab').forEach(x => x.classList.remove('active'));
    t.classList.add('active'); currentFilter = t.dataset.filter; render();
  });
});
setInterval(render, 60000);
renderRecent(); render();
</script>
</body>
</html>
