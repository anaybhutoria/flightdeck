<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<meta name="theme-color" content="#0a0e1a">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>FlightDeck</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--bg:#0a0e1a;--card:#141828;--card2:#1a2035;--accent:#6c63ff;--accent2:#00d4aa;--text:#e8eaf6;--text2:#8892b0;--danger:#ff5252;--warn:#ffab40;--success:#69f0ae;--radius:16px;--shadow:0 8px 32px rgba(0,0,0,.4)}
html,body{height:100%;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:var(--bg);color:var(--text);overflow-x:hidden;-webkit-tap-highlight-color:transparent}
body{padding:env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left)}
::-webkit-scrollbar{width:4px}::-webkit-scrollbar-thumb{background:var(--accent);border-radius:4px}

.header{position:sticky;top:0;z-index:100;background:linear-gradient(180deg,var(--bg) 60%,transparent);padding:20px 16px 30px;backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px)}
.header h1{font-size:28px;font-weight:800;background:linear-gradient(135deg,var(--accent),var(--accent2));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;display:flex;align-items:center;gap:10px}
.header h1 span{font-size:24px;-webkit-text-fill-color:initial}
.header p{color:var(--text2);font-size:13px;margin-top:4px}

.search-wrap{margin:0 16px 16px;position:relative}
.search-wrap input{width:100%;padding:16px 54px 16px 20px;border:2px solid transparent;border-radius:var(--radius);background:var(--card);color:var(--text);font-size:16px;outline:none;transition:.3s}
.search-wrap input:focus{border-color:var(--accent);box-shadow:0 0 0 4px rgba(108,99,255,.15)}
.search-wrap input::placeholder{color:var(--text2)}
.search-btn{position:absolute;right:6px;top:50%;transform:translateY(-50%);width:42px;height:42px;border:none;border-radius:12px;background:var(--accent);color:#fff;font-size:20px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:.2s}
.search-btn:active{transform:translateY(-50%) scale(.9)}

.tabs{display:flex;margin:0 16px 8px;gap:8px}
.tab{flex:1;padding:10px;border:none;border-radius:12px;background:var(--card);color:var(--text2);font-size:13px;font-weight:600;cursor:pointer;transition:.3s}
.tab.active{background:var(--accent);color:#fff}

.cards{padding:8px 16px 100px;display:flex;flex-direction:column;gap:12px}

/* Loading */
.loading{text-align:center;padding:40px 20px;color:var(--accent)}
.loading .spinner{width:40px;height:40px;border:3px solid var(--card2);border-top-color:var(--accent);border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 16px}
@keyframes spin{to{transform:rotate(360deg)}}

/* Flight card */
.flight-card{background:var(--card);border-radius:var(--radius);padding:20px;position:relative;overflow:hidden;animation:slideUp .4s ease;transition:transform .2s}
.flight-card:active{transform:scale(.98)}
@keyframes slideUp{from{opacity:0;transform:translateY(30px)}to{opacity:1;transform:translateY(0)}}

.card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
.flight-num{font-size:22px;font-weight:800;letter-spacing:1px}
.airline-name{font-size:12px;color:var(--text2);margin-top:2px}
.status-badge{padding:5px 12px;border-radius:20px;font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.5px}
.status-green{background:rgba(105,240,174,.15);color:var(--success)}
.status-yellow{background:rgba(255,171,64,.15);color:var(--warn)}
.status-red{background:rgba(255,82,82,.15);color:var(--danger)}
.status-blue{background:rgba(108,99,255,.15);color:var(--accent)}

.route{display:flex;align-items:center;gap:8px;margin-bottom:16px}
.airport{text-align:center;flex:1}
.airport .code{font-size:26px;font-weight:800}
.airport .city{font-size:11px;color:var(--text2);margin-top:2px}
.airport .time{font-size:15px;color:var(--text);margin-top:6px;font-weight:600}
.airport .time-label{font-size:10px;color:var(--text2)}
.airport .time-actual{color:var(--success);font-size:13px}
.airport .time-delayed{color:var(--danger);text-decoration:line-through;font-size:12px;opacity:.7}
.route-line{flex:2;display:flex;align-items:center;position:relative;height:30px}
.route-line::before{content:'';position:absolute;top:50%;left:0;right:0;height:2px;background:linear-gradient(90deg,var(--accent),var(--accent2));border-radius:1px}
.route-line .plane{position:absolute;font-size:20px;top:50%;transform:translateY(-50%);filter:drop-shadow(0 0 6px var(--accent))}
.route-line .plane.flying{animation:fly 3s ease-in-out infinite alternate}
@keyframes fly{from{left:10%}to{left:80%}}

.progress-bar{width:100%;height:6px;background:var(--card2);border-radius:3px;margin:8px 0 16px;overflow:hidden}
.progress-fill{height:100%;background:linear-gradient(90deg,var(--accent),var(--accent2));border-radius:3px;transition:width 1s ease}

.detail-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(100px,1fr));gap:8px;margin-top:12px}
.detail-item{background:var(--card2);border-radius:10px;padding:10px;text-align:center}
.detail-item .label{font-size:10px;color:var(--text2);text-transform:uppercase;letter-spacing:.5px}
.detail-item .value{font-size:14px;font-weight:700;margin-top:4px}

.codeshares{margin-top:12px;padding:10px;background:var(--card2);border-radius:10px;font-size:12px;color:var(--text2)}
.codeshares strong{color:var(--text)}

.countdown{margin-top:12px;padding:12px;border-radius:12px;background:rgba(108,99,255,.08);text-align:center;font-size:14px;color:var(--accent);font-weight:600}

.card-actions{position:absolute;top:12px;right:12px;display:flex;gap:6px}
.card-actions button{width:32px;height:32px;border:none;border-radius:8px;background:rgba(255,255,255,.05);color:var(--text2);font-size:14px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:.2s}
.card-actions button:hover{background:rgba(255,82,82,.15);color:var(--danger)}

.empty{text-align:center;padding:60px 20px;color:var(--text2)}
.empty .icon{font-size:64px;margin-bottom:16px;opacity:.5}
.empty p{font-size:15px;line-height:1.6}

.error-msg{text-align:center;padding:30px 20px;color:var(--danger);background:var(--card);border-radius:var(--radius);margin:0 16px}

.fab{position:fixed;bottom:24px;right:20px;width:56px;height:56px;border:none;border-radius:50%;background:linear-gradient(135deg,var(--accent),var(--accent2));color:#fff;font-size:28px;cursor:pointer;box-shadow:0 8px 24px rgba(108,99,255,.4);z-index:50;display:flex;align-items:center;justify-content:center;transition:.2s}
.fab:active{transform:scale(.9)}

.toast{position:fixed;bottom:90px;left:50%;transform:translateX(-50%) translateY(100px);background:var(--card2);color:var(--text);padding:12px 24px;border-radius:12px;font-size:14px;font-weight:600;z-index:300;transition:.3s;opacity:0;box-shadow:var(--shadow)}
.toast.show{transform:translateX(-50%) translateY(0);opacity:1}

/* Modal */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:200;display:none;align-items:flex-end;justify-content:center;backdrop-filter:blur(4px)}
.modal-overlay.show{display:flex;animation:fadeIn .2s}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
.modal{background:var(--card);border-radius:var(--radius) var(--radius) 0 0;padding:24px 20px 40px;width:100%;max-width:500px;max-height:85vh;overflow-y:auto;animation:slideModal .3s ease}
@keyframes slideModal{from{transform:translateY(100%)}to{transform:translateY(0)}}
.modal h2{font-size:20px;font-weight:700;margin-bottom:20px;display:flex;align-items:center;gap:8px}
.modal label{display:block;font-size:13px;color:var(--text2);margin-bottom:6px;font-weight:600}
.modal input,.modal select{width:100%;padding:14px 16px;border:2px solid rgba(255,255,255,.06);border-radius:12px;background:var(--bg);color:var(--text);font-size:15px;outline:none;margin-bottom:16px;transition:.3s}
.modal input:focus,.modal select:focus{border-color:var(--accent)}
.row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.modal-btns{display:flex;gap:10px;margin-top:8px}
.modal-btns button{flex:1;padding:14px;border:none;border-radius:12px;font-size:15px;font-weight:700;cursor:pointer;transition:.2s}
.btn-primary{background:var(--accent);color:#fff}
.btn-primary:active{transform:scale(.96)}
.btn-secondary{background:rgba(255,255,255,.06);color:var(--text2)}

.recent-searches{margin:0 16px 16px;display:flex;gap:8px;flex-wrap:wrap}
.recent-chip{padding:6px 14px;border-radius:20px;background:var(--card);color:var(--text2);font-size:12px;font-weight:600;cursor:pointer;transition:.2s;border:1px solid rgba(255,255,255,.06)}
.recent-chip:hover{border-color:var(--accent);color:var(--text)}
</style>
</head>
<body>

<div class="header">
  <h1><span>‚úàÔ∏è</span> FlightDeck</h1>
  <p id="subtitle">Live flight tracking</p>
</div>

<div class="search-wrap">
  <input type="text" id="searchInput" placeholder="Flight number (e.g. AC226, WS137)" autocomplete="off" autocapitalize="characters" spellcheck="false">
  <button class="search-btn" id="searchBtn" aria-label="Search">üîç</button>
</div>

<div class="recent-searches" id="recentSearches"></div>

<div class="tabs">
  <button class="tab active" data-filter="live">üî¥ Live</button>
  <button class="tab" data-filter="saved">üíæ Saved</button>
</div>

<div class="cards" id="cards"></div>

<button class="fab" id="fab" aria-label="Refresh">‚Üª</button>

<!-- Manual Add Modal -->
<div class="modal-overlay" id="modal">
  <div class="modal">
    <h2>‚úàÔ∏è Add Flight Manually</h2>
    <label>Flight Number</label>
    <input type="text" id="fNum" placeholder="AC226" autocapitalize="characters">
    <div class="row">
      <div><label>From</label><input type="text" id="fFrom" placeholder="YVR" maxlength="4" autocapitalize="characters"></div>
      <div><label>To</label><input type="text" id="fTo" placeholder="YYC" maxlength="4" autocapitalize="characters"></div>
    </div>
    <div class="row">
      <div><label>Departure</label><input type="datetime-local" id="fDepart"></div>
      <div><label>Arrival</label><input type="datetime-local" id="fArrive"></div>
    </div>
    <label>Notes</label>
    <input type="text" id="fNotes" placeholder="Window seat, row 12A">
    <div class="modal-btns">
      <button class="btn-primary" id="saveBtn">Save</button>
      <button class="btn-secondary" onclick="closeModal()">Cancel</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
const PROXY = 'https://api.allorigins.win/get?url=';
const FS_BASE = 'https://www.flightstats.com/v2/flight-tracker/';
const LS_FLIGHTS = 'fd_flights';
const LS_RECENT = 'fd_recent';
const LS_SAVED = 'fd_saved';

let liveFlights = JSON.parse(localStorage.getItem(LS_FLIGHTS) || '[]');
let savedFlights = JSON.parse(localStorage.getItem(LS_SAVED) || '[]');
let recentSearches = JSON.parse(localStorage.getItem(LS_RECENT) || '[]');
let currentFilter = 'live';
let isLoading = false;

const $ = id => document.getElementById(id);

function toast(msg) {
  const t = $('toast'); t.textContent = msg; t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2200);
}

function saveLive() { localStorage.setItem(LS_FLIGHTS, JSON.stringify(liveFlights)); }
function saveSaved() { localStorage.setItem(LS_SAVED, JSON.stringify(savedFlights)); }
function saveRecent() { localStorage.setItem(LS_RECENT, JSON.stringify(recentSearches)); }

function addRecent(q) {
  recentSearches = [q, ...recentSearches.filter(r => r !== q)].slice(0, 8);
  saveRecent();
  renderRecent();
}

function renderRecent() {
  $('recentSearches').innerHTML = recentSearches.map(r =>
    `<div class="recent-chip" onclick="searchFlight('${r}')">${r}</div>`
  ).join('');
}

function parseFlightCode(input) {
  const clean = input.trim().toUpperCase().replace(/\s+/g, '');
  const m = clean.match(/^([A-Z]{2}|\d[A-Z]|[A-Z]\d)(\d{1,4})$/);
  if (m) return { carrier: m[1], number: m[2] };
  return null;
}

async function fetchFlightData(carrier, number) {
  const url = `${FS_BASE}${carrier}/${number}`;
  const resp = await fetch(`${PROXY}${encodeURIComponent(url)}`);
  if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
  const data = await resp.json();
  if (!data.contents) throw new Error('Empty response');

  const match = data.contents.match(/__NEXT_DATA__\s*=\s*({.*?});/s);
  if (!match) throw new Error('Could not parse flight data');

  const nextData = JSON.parse(match[1]);
  const ft = nextData.props?.initialState?.flightTracker;
  if (!ft?.flight) throw new Error('No flight data found');
  return ft;
}

function buildFlightCard(ft, isLive = true) {
  const f = ft.flight;
  const dep = f.departureAirport;
  const arr = f.arrivalAirport;
  const sched = f.schedule;
  const stat = f.status;
  const info = f.additionalFlightInfo;
  const header = f.resultHeader;

  const statusColor = stat.color === 'green' ? 'status-green' :
                      stat.color === 'yellow' ? 'status-yellow' :
                      stat.color === 'red' ? 'status-red' : 'status-blue';

  const isFlying = f.flightNote?.tracking || f.flightState === 'active';
  const isLanded = f.flightNote?.landed || f.flightState === 'completed';
  const isFuture = f.flightState === 'future';

  // Progress calc
  let progress = 0;
  if (isLanded) progress = 100;
  else if (isFlying && sched.scheduledDepartureUTC && sched.scheduledArrivalUTC) {
    const depT = new Date(sched.scheduledDepartureUTC).getTime();
    const arrT = new Date(sched.scheduledArrivalUTC).getTime();
    const now = Date.now();
    progress = Math.min(95, Math.max(5, ((now - depT) / (arrT - depT)) * 100));
  }

  // Countdown
  let countdown = '';
  if (isFuture && sched.scheduledDepartureUTC) {
    const diff = new Date(sched.scheduledDepartureUTC) - new Date();
    if (diff > 0) {
      const h = Math.floor(diff / 36e5), m = Math.floor((diff % 36e5) / 6e4);
      if (h > 48) { const d = Math.floor(h / 24); countdown = `${d}d ${h % 24}h until departure`; }
      else countdown = h > 0 ? `${h}h ${m}m until departure` : `${m}m until departure`;
    }
  }

  // Times
  const depSched = dep.times?.scheduled ? `${dep.times.scheduled.time24} ${dep.times.scheduled.timezone}` : '--:--';
  const arrSched = arr.times?.scheduled ? `${arr.times.scheduled.time24} ${arr.times.scheduled.timezone}` : '--:--';
  const depActual = dep.times?.estimatedActual?.time24 ? `${dep.times.estimatedActual.time24} ${dep.times.estimatedActual.timezone || ''}` : null;
  const arrActual = arr.times?.estimatedActual?.time24 ? `${arr.times.estimatedActual.time24} ${arr.times.estimatedActual.timezone || ''}` : null;

  const depTimeHtml = depActual && depActual !== depSched
    ? `<div class="time-delayed">${depSched}</div><div class="time-actual">${depActual}</div>`
    : `<div class="time">${depSched}</div>`;
  const arrTimeHtml = arrActual && arrActual !== arrSched
    ? `<div class="time-delayed">${arrSched}</div><div class="time-actual">${arrActual}</div>`
    : `<div class="time">${arrSched}</div>`;

  const flightId = `${header.carrier.fs}${header.flightNumber}`;
  const isSaved = savedFlights.some(s => s.id === flightId);

  // Codeshares
  let codeshareHtml = '';
  if (f.codeshares?.length) {
    codeshareHtml = `<div class="codeshares">Also marketed as: <strong>${f.codeshares.map(c => `${c.fs} ${c.flightNumber}`).join(', ')}</strong></div>`;
  }

  return `
  <div class="flight-card" data-id="${flightId}">
    <div class="card-actions">
      <button onclick="toggleSave('${flightId}')" title="${isSaved ? 'Unsave' : 'Save'}">${isSaved ? '‚≠ê' : '‚òÜ'}</button>
      <button onclick="removeLive('${flightId}')" title="Remove">‚úï</button>
    </div>
    <div class="card-header">
      <div>
        <div class="flight-num">${header.carrier.fs} ${header.flightNumber}</div>
        <div class="airline-name">${header.carrier.name}</div>
      </div>
      <div class="status-badge ${statusColor}">${stat.status}${stat.statusDescription ? ' ¬∑ ' + stat.statusDescription : ''}</div>
    </div>
    <div class="route">
      <div class="airport">
        <div class="code">${dep.fs}</div>
        <div class="city">${dep.city}${dep.state ? ', ' + dep.state : ''}</div>
        <div class="time-label">Departure</div>
        ${depTimeHtml}
      </div>
      <div class="route-line">
        <div class="plane ${isFlying ? 'flying' : ''}" style="${isLanded ? 'left:95%' : isFlying ? '' : 'left:5%;animation:none'}">${isFlying ? '‚úàÔ∏è' : isLanded ? 'üõ¨' : '‚úàÔ∏è'}</div>
      </div>
      <div class="airport">
        <div class="code">${arr.fs}</div>
        <div class="city">${arr.city}${arr.state ? ', ' + arr.state : ''}</div>
        <div class="time-label">Arrival</div>
        ${arrTimeHtml}
      </div>
    </div>
    ${(isFlying || isLanded) ? `<div class="progress-bar"><div class="progress-fill" style="width:${progress}%"></div></div>` : ''}
    <div class="detail-grid">
      ${dep.terminal ? `<div class="detail-item"><div class="label">Terminal</div><div class="value">${dep.terminal}</div></div>` : ''}
      ${dep.gate ? `<div class="detail-item"><div class="label">Dep Gate</div><div class="value">${dep.gate}</div></div>` : ''}
      ${arr.gate ? `<div class="detail-item"><div class="label">Arr Gate</div><div class="value">${arr.gate}</div></div>` : ''}
      ${arr.terminal ? `<div class="detail-item"><div class="label">Arr Term</div><div class="value">${arr.terminal}</div></div>` : ''}
      ${arr.baggage ? `<div class="detail-item"><div class="label">Baggage</div><div class="value">${arr.baggage}</div></div>` : ''}
      ${info?.equipment?.name ? `<div class="detail-item"><div class="label">Aircraft</div><div class="value">${info.equipment.name}</div></div>` : ''}
      ${info?.flightDuration ? `<div class="detail-item"><div class="label">Duration</div><div class="value">${info.flightDuration}</div></div>` : ''}
      ${stat.delay?.departure?.minutes > 0 ? `<div class="detail-item"><div class="label">Delay</div><div class="value" style="color:var(--danger)">${stat.delay.departure.minutes}m</div></div>` : ''}
    </div>
    ${codeshareHtml}
    ${countdown ? `<div class="countdown">‚è± ${countdown}</div>` : ''}
  </div>`;
}

function render() {
  const c = $('cards');
  if (isLoading) {
    c.innerHTML = `<div class="loading"><div class="spinner"></div>Fetching flight data...</div>`;
    return;
  }

  if (currentFilter === 'live') {
    if (!liveFlights.length) {
      c.innerHTML = `<div class="empty"><div class="icon">‚úàÔ∏è</div><p>Search for a flight to get started.<br>Try AC226, WS137, UA100...</p></div>`;
    } else {
      c.innerHTML = liveFlights.map(f => buildFlightCard(f, true)).join('');
    }
  } else {
    if (!savedFlights.length) {
      c.innerHTML = `<div class="empty"><div class="icon">‚≠ê</div><p>No saved flights yet.<br>Star a flight to save it here.</p></div>`;
    } else {
      c.innerHTML = savedFlights.map(f => buildFlightCard(f, false)).join('');
    }
  }

  const total = liveFlights.length + savedFlights.length;
  $('subtitle').textContent = total ? `Tracking ${total} flight${total !== 1 ? 's' : ''}` : 'Live flight tracking';
}

async function searchFlight(query) {
  const q = query || $('searchInput').value;
  const parsed = parseFlightCode(q);
  if (!parsed) { toast('Invalid flight number'); return; }

  $('searchInput').value = `${parsed.carrier}${parsed.number}`;
  addRecent(`${parsed.carrier}${parsed.number}`);
  isLoading = true;
  render();

  try {
    const ft = await fetchFlightData(parsed.carrier, parsed.number);
    const flightId = `${parsed.carrier}${parsed.number}`;
    liveFlights = liveFlights.filter(f => {
      const fid = `${f.flight.resultHeader.carrier.fs}${f.flight.resultHeader.flightNumber}`;
      return fid !== flightId;
    });
    liveFlights.unshift(ft);
    saveLive();
    currentFilter = 'live';
    document.querySelectorAll('.tab').forEach(t => t.classList.toggle('active', t.dataset.filter === 'live'));
    toast('Flight data loaded ‚úàÔ∏è');
  } catch (err) {
    toast('Could not find flight: ' + err.message);
  }

  isLoading = false;
  render();
}

function removeLive(id) {
  liveFlights = liveFlights.filter(f => {
    const fid = `${f.flight.resultHeader.carrier.fs}${f.flight.resultHeader.flightNumber}`;
    return fid !== id;
  });
  saveLive();
  render();
  toast('Flight removed');
}

function toggleSave(id) {
  const existing = savedFlights.findIndex(f => {
    const fid = `${f.flight.resultHeader.carrier.fs}${f.flight.resultHeader.flightNumber}`;
    return fid === id;
  });
  if (existing >= 0) {
    savedFlights.splice(existing, 1);
    saveSaved();
    render();
    toast('Removed from saved');
  } else {
    const flight = liveFlights.find(f => {
      const fid = `${f.flight.resultHeader.carrier.fs}${f.flight.resultHeader.flightNumber}`;
      return fid === id;
    });
    if (flight) {
      savedFlights.unshift(flight);
      saveSaved();
      render();
      toast('Saved ‚≠ê');
    }
  }
}

// Refresh all live flights
async function refreshAll() {
  toast('Refreshing...');
  const toRefresh = [...liveFlights];
  for (const ft of toRefresh) {
    const carrier = ft.flight.resultHeader.carrier.fs;
    const number = ft.flight.resultHeader.flightNumber;
    try {
      const updated = await fetchFlightData(carrier, number);
      const idx = liveFlights.findIndex(f =>
        f.flight.resultHeader.carrier.fs === carrier &&
        f.flight.resultHeader.flightNumber === number
      );
      if (idx >= 0) liveFlights[idx] = updated;
    } catch (e) { /* keep old data */ }
  }
  saveLive();
  render();
  toast('Refreshed ‚úÖ');
}

// Search handlers
$('searchBtn').addEventListener('click', () => searchFlight());
$('searchInput').addEventListener('keydown', e => { if (e.key === 'Enter') searchFlight(); });

// Tab handlers
document.querySelectorAll('.tab').forEach(t => {
  t.addEventListener('click', () => {
    document.querySelectorAll('.tab').forEach(x => x.classList.remove('active'));
    t.classList.add('active');
    currentFilter = t.dataset.filter;
    render();
  });
});

// FAB = refresh
$('fab').addEventListener('click', refreshAll);

// Countdown ticker
setInterval(render, 60000);

// Init
renderRecent();
render();
</script>
</body>
</html>
